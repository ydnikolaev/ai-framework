# üõ°Ô∏è QA & Deployment Standards

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç —É—Ä–æ–∫–∏, –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –∏–∑ –æ—Ç–ª–∞–¥–∫–∏ –ø—Ä–æ–¥–∞–∫—à–Ω-–æ–∫—Ä—É–∂–µ–Ω–∏—è, –∏ –ø—Ä–∞–≤–∏–ª–∞, –∫–æ—Ç–æ—Ä—ã–µ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –Ω—É–∂–Ω–æ —Å–æ–±–ª—é–¥–∞—Ç—å, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –æ—à–∏–±–æ–∫.

## üõë Critical Rules (LLM Self-Correction)

–ü–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º –∑–∞–¥–∞—á–∏ –∞–≥–µ–Ω—Ç **–û–ë–Ø–ó–ê–ù**:
1.  **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ–Ω—Ñ–∏–≥–æ–≤:** –û—Å–æ–±–µ–Ω–Ω–æ `nuxt.config.ts`.
    *   ‚ùå –ù–ï –î–£–ë–õ–ò–†–û–í–ê–¢–¨ –∫–ª—é—á–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `typescript: {}` –≤–Ω—É—Ç—Ä–∏ `typescript: {}`).
    *   ‚ùå –ù–ï –û–°–¢–ê–í–õ–Ø–¢–¨ –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–µ —Å–∫–æ–±–∫–∏.
2.  **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã:**
    *   ‚ö†Ô∏è –í —Ñ–∞–π–ª–∞—Ö `.ts` (composables) –∞–≤—Ç–æ-–∏–º–ø–æ—Ä—Ç—ã Nuxt –º–æ–≥—É—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –¥–ª—è top-level –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö.
    *   ‚úÖ –í–°–ï–ì–î–ê —è–≤–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `ref`, `computed`, `onMounted` –∏–∑ 'vue' –≤ –Ω–∞—á–∞–ª–µ `useSomething.ts`.
3.  **–ó–∞–ø—É—Å—Ç–∏—Ç—å –õ–∏–Ω—Ç–µ—Ä:**
    *   ‚úÖ –í—ã–ø–æ–ª–Ω–∏—Ç—å `npm run lint` –ø–µ—Ä–µ–¥ —Ç–µ–º, –∫–∞–∫ –ø—Ä–æ—Å–∏—Ç—å —é–∑–µ—Ä–∞ —Å–¥–µ–ª–∞—Ç—å push.

## üöÄ Deployment & Docker

### 1. Nuxt Configuration for Docker
–ü—Ä–∏ —Å–±–æ—Ä–∫–µ –≤ Docker (–æ—Å–æ–±–µ–Ω–Ω–æ Alpine) –≤–æ–∑–Ω–∏–∫–∞—é—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã.

*   **TypeCheck:** –î–æ–ª–∂–µ–Ω –±—ã—Ç—å **–í–´–ö–õ–Æ–ß–ï–ù** –≤ `nuxt.config.ts`.
    ```typescript
    typescript: {
      typeCheck: false // ‚úÖ Docker fail fix: auto-imports are not ready at build time
    }
    ```
    *–ü–æ—á–µ–º—É:* `vue-tsc` –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –¥–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ `.nuxt`, –∏ –ø–∞–¥–∞–µ—Ç —Å –æ—à–∏–±–∫–æ–π `Cannot find name 'use...'`. –ü—Ä–æ–≤–µ—Ä–∫—É —Ç–∏–ø–æ–≤ –¥–µ–ª–∞–µ–º —Ç–æ–ª—å–∫–æ –≤ CI (`npm run typecheck`).

*   **Nitro Preset:** –î–æ–ª–∂–µ–Ω –±—ã—Ç—å —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω –∫–∞–∫ `node-server`.
    ```typescript
    nitro: {
      preset: 'node-server' // ‚úÖ Prevents "Exited (0)" immediate shutdown
    }
    ```
    *–ü–æ—á–µ–º—É:* –ë–µ–∑ —ç—Ç–æ–≥–æ Nuxt –º–æ–∂–µ—Ç —Å–æ–±—Ä–∞—Ç—å "—Å–∫—Ä–∏–ø—Ç" –≤–º–µ—Å—Ç–æ —Å–µ—Ä–≤–µ—Ä–∞, –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—ã–∫–ª—é—á–∏—Ç—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞.

### 2. Debugging Production
–ï—Å–ª–∏ "–≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ, –Ω–æ –Ω–µ –Ω–∞ –ø—Ä–æ–¥–µ":

1.  **Browser Cache:**
    *   –°–∏–º–ø—Ç–æ–º: –ë—ç–∫–µ–Ω–¥ —Ä—É–≥–∞–µ—Ç—Å—è –Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º—ã —Ç–æ—á–Ω–æ –¥–æ–±–∞–≤–∏–ª–∏.
    *   –ü—Ä–∏—á–∏–Ω–∞: –ë—Ä–∞—É–∑–µ—Ä/Telegram –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å—Ç–∞—Ä—ã–π `.js` —Ñ–∞–π–ª.
    *   –†–µ—à–µ–Ω–∏–µ: –°—Ä–∞–≤–Ω–∏—Ç—å –ª–æ–≥–∏. –ï—Å–ª–∏ –Ω–æ–≤—ã—Ö –ª–æ–≥–æ–≤ –Ω–µ—Ç ‚Äî –∫–æ–¥ —Å—Ç–∞—Ä—ã–π.

2.  **Container Stale State:**
    *   –°–∏–º–ø—Ç–æ–º: GitHub Actions "Green", –Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç.
    *   –ü—Ä–æ–≤–µ—Ä–∫–∞: `docker ps` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –ï—Å–ª–∏ `Up 2 weeks` ‚Äî —Ä–µ—Å—Ç–∞—Ä—Ç–∞ –Ω–µ –±—ã–ª–æ.
    *   –†–µ—à–µ–Ω–∏–µ: `docker compose down && docker compose up -d --build`.

## üß© TypeScript & Composables
*   **Singleton Pattern:** –î–ª—è –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –∂–∏—Ç—å –≤—Å–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (User Session, InitData), –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞—Ç—Ç–µ—Ä–Ω —Å–∏–Ω–≥–ª—Ç–æ–Ω–∞ (–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤–Ω–µ `export const function`).
    *   ‚ö†Ô∏è **–í–ê–ñ–ù–û:** –ù–µ –∑–∞–±—ã–≤–∞–π –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `ref` –¥–ª—è —ç—Ç–∏—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö!

```typescript
import { ref } from 'vue'; // ‚úÖ REQUIRED

const user = ref(null); // Singleton

export const useUser = () => { ... }
```

---

## üñºÔ∏è Images & Media

### –ú–∏–≥–∞–Ω–∏–µ –±–∏—Ç–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –Ω–∞ –¥–æ–ª—é —Å–µ–∫—É–Ω–¥—ã –º–µ–ª—å–∫–∞–µ—Ç –∏–∫–æ–Ω–∫–∞ "—Å–ª–æ–º–∞–Ω–Ω–æ–≥–æ" –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –ø—Ä–µ–∂–¥–µ —á–µ–º –ø–æ—è–≤–ª—è–µ—Ç—Å—è fallback.

**–ü—Ä–∏—á–∏–Ω–∞:** –£—Å–ª–æ–≤–∏–µ `v-if="poster && !posterError"` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç `<img>` —Å—Ä–∞–∑—É, –ø–æ–∫–∞ –æ–Ω –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è.

**–†–µ—à–µ–Ω–∏–µ:** –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å fallback –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –∞ –∫–∞—Ä—Ç–∏–Ω–∫—É –¥–µ–ª–∞—Ç—å `opacity-0` –¥–æ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏:

```vue
<!-- Image preloads invisibly -->
<img 
  v-if="poster && !posterError" 
  :src="poster"
  class="absolute inset-0 transition-opacity"
  :class="posterLoaded ? 'opacity-100' : 'opacity-0'"
  @load="posterLoaded = true"
  @error="posterError = true"
>
<!-- Fallback visible until image loads -->
<div v-if="!poster || posterError || !posterLoaded">
  <!-- fallback content -->
</div>
```

**–§–∞–π–ª:** `frontend/components/MovieCard.vue`

---

## ü§ñ Telegram Bot

### Conflict: terminated by other getUpdates request

**–°–∏–º–ø—Ç–æ–º:** –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ –æ—à–∏–±–∫–∞:
```
Conflict: terminated by other getUpdates request; make sure that only one bot instance is running
```

**–ü—Ä–∏—á–∏–Ω–∞:** –ó–∞–ø—É—â–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –±–æ—Ç–∞ —Å –æ–¥–Ω–∏–º –∏ —Ç–µ–º –∂–µ —Ç–æ–∫–µ–Ω–æ–º. –û–±—ã—á–Ω–æ:
- –î–≤–∞–∂–¥—ã –∑–∞–ø—É—â–µ–Ω `make dev-full` –±–µ–∑ –∑–∞–∫—Ä—ã—Ç–∏—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ–∫–Ω–∞ iTerm2
- –ë–æ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç dev-—Ç–æ–∫–µ–Ω –≤–º–µ—Å—Ç–æ production

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–∞ (–≤–∫–ª—é—á–∞—è —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –±–∏–Ω–∞—Ä–Ω–∏–∫–∏)
pgrep -fl bot | grep -v grep

# –ò–ª–∏ –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ
ps aux | grep -E "(go run|cmd/bot|exe/bot)" | grep -v grep

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ  
ssh deploy@server "grep TELEGRAM_BOT_TOKEN ~/project/.env"
```

> **–í–∞–∂–Ω–æ:** `go run` –∑–∞–ø—É—Å–∫–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–π –±–∏–Ω–∞—Ä–Ω–∏–∫ –≤ `/var/folders/.../exe/bot` –∏–ª–∏ `go-build/.../bot`. 
> –ö–æ–º–∞–Ω–¥–∞ `make bot-stop` —É–±–∏–≤–∞–µ—Ç –∏ —ç—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å—ã.

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–∞
make bot-stop

# –ò–ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å—ë dev-–æ–∫—Ä—É–∂–µ–Ω–∏–µ
make dev-stop
```

**–ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞:** 
- `make dev-full` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º
- –ò—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –¥–ª—è dev (`@DevBot`) –∏ prod (`@ProdBot`)

---

## üîó Dev Tunnel

### Gateway Timeout (504) –Ω–∞ dev.waydownwego.ru

**–°–∏–º–ø—Ç–æ–º:** –¢—É–Ω–Ω–µ–ª—å –∑–∞–ø—É—â–µ–Ω, –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ https://dev.waydownwego.ru –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 504.

**–ü—Ä–∏—á–∏–Ω–∞:** UFW –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç—Ä–∞—Ñ–∏–∫ –æ—Ç Docker —Å–µ—Ç–∏ –∫ –ø–æ—Ä—Ç—É —Ç—É–Ω–Ω–µ–ª—è.

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å–ª—É—à–∞–µ—Ç –ª–∏ –ø–æ—Ä—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
ssh deploy@server "ss -tlnp | grep 31337"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –º–æ–∂–µ—Ç –ª–∏ Docker –¥–æ—Å—Ç—É—á–∞—Ç—å—Å—è
ssh deploy@server "docker exec traefik wget -qO- http://host.docker.internal:31337 --timeout=5"
```

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –û—Ç–∫—Ä—ã—Ç—å –ø–æ—Ä—Ç –¥–ª—è Docker —Å–µ—Ç–µ–π
ssh deploy@server "sudo ufw allow from 172.17.0.0/16 to any port 31337"
ssh deploy@server "sudo ufw allow from 172.18.0.0/16 to any port 31337"
ssh deploy@server "sudo ufw reload"

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç—É–Ω–Ω–µ–ª—å
make tunnel
```

> üìñ –ü–æ–ª–Ω—ã–π –≥–∞–π–¥: [dev-tunnel.md](../operations/dev-tunnel.md)

---

## üê≥ Docker

### Bad Gateway / –°–µ—Ä—ã–π —ç–∫—Ä–∞–Ω Telegram (Frozen Containers)

**–°–∏–º–ø—Ç–æ–º:** 
- TMA –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç Bad Gateway (502) –∏–ª–∏ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Å–µ—Ä—ã–π —ç–∫—Ä–∞–Ω —Å –ª–æ–∞–¥–µ—Ä–æ–º
- –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç
- –ü—Ä–∏ —ç—Ç–æ–º `docker ps` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∫–∞–∫ "Up"
- –õ–æ–∫–∞–ª—å–Ω–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç, —Ç—É–Ω–Ω–µ–ª—å –æ—Ç–∫—Ä—ã—Ç

**–ü—Ä–∏—á–∏–Ω–∞:** Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø–µ—Ä–µ—à–ª–∏ –≤ stale/frozen —Å–æ—Å—Ç–æ—è–Ω–∏–µ. –ü—Ä–æ—Ü–µ—Å—Å—ã –∂–∏–≤—ã, –Ω–æ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –∑–∞–ø—Ä–æ—Å—ã. –ß–∞—â–µ –≤—Å–µ–≥–æ –ø–æ—Å–ª–µ –¥–æ–ª–≥–æ–≥–æ uptime –±–µ–∑ —Ä–µ—Å—Ç–∞—Ä—Ç–∞.

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
ssh deploy@server "docker ps"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏
ssh deploy@server "cd ~/project && docker compose logs --tail=50"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ HTTP
curl -sI https://your-domain.com
```

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ë—ã—Å—Ç—Ä—ã–π —Ä–µ—Å—Ç–∞—Ä—Ç
ssh deploy@server "cd ~/project && docker compose restart"

# –ü–æ–ª–Ω—ã–π rebuild (–µ—Å–ª–∏ —Ä–µ—Å—Ç–∞—Ä—Ç –Ω–µ –ø–æ–º–æ–≥)
ssh deploy@server "cd ~/project && docker compose down && docker compose up -d --build"
```

**–ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞:**
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π —Ä–µ—Å—Ç–∞—Ä—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (`docker compose restart`)
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å healthcheck –≤ `docker-compose.yml`
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ uptime —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Ä–µ—Å—Ç–∞—Ä—Ç–æ–º
