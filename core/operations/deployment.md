# üöÄ –ì–∞–π–¥ –ø–æ –î–µ–ø–ª–æ—é

–í –Ω–∞—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–¥–µ–Ω—Ç–∏—á–Ω–∞—è —Å—Ö–µ–º–∞ –¥–µ–ø–ª–æ—è: **GitHub Actions -> VPS (Docker Compose)**.

## 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –°–µ—Ä–≤–µ—Ä–∞ (VPS)

1.  **OS:** Ubuntu 24.04 (LTS).
2.  **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:** –°–æ–∑–¥–∞–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `deploy` (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π root).
3.  **Docker:** –£—Å—Ç–∞–Ω–æ–≤–∏ Docker –∏ Docker Compose Plugin.
4.  **Traefik:** –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω Traefik –∫–∞–∫ –≥–ª–æ–±–∞–ª—å–Ω—ã–π Reverse Proxy (–æ–±—ã—á–Ω–æ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å–µ—Ç–∏ `web`).

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–æ–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
–ü—Ä–∏ –¥–µ–ø–ª–æ–µ GitHub Action —Å–æ–∑–¥–∞—Å—Ç –ø–∞–ø–∫—É `~/project-name` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `~/kinobot`) –∏ —Å–∫–æ–ø–∏—Ä—É–µ—Ç —Ç—É–¥–∞ —Ñ–∞–π–ª—ã.

## 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (GitHub)

–í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (`Settings -> Secrets and variables -> Actions`) –¥–æ–±–∞–≤—å —Å–µ–∫—Ä–µ—Ç—ã:

| –°–µ–∫—Ä–µ—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|
| `SSH_HOST` | IP –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞ |
| `SSH_USER` | –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, `deploy`) |
| `SSH_KEY` | –ü—Ä–∏–≤–∞—Ç–Ω—ã–π SSH –∫–ª—é—á (—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π –ø–∞—Ä—É `ssh-keygen`, –ø—É–±–ª–∏—á–Ω—ã–π –ø–æ–ª–æ–∂–∏ –≤ `~/.ssh/authorized_keys` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ) |
| `SSH_PORT` | –ü–æ—Ä—Ç SSH (–µ—Å–ª–∏ –Ω–µ 22) |

### –°–µ–∫—Ä–µ—Ç—ã-—Ñ–∞–π–ª—ã (Google Credentials –∏ –¥—Ä.)
–î–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ JSON-—Ñ–∞–π–ª–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `google-cloud.json`) –º—ã –Ω–µ —Ö—Ä–∞–Ω–∏–º –∏—Ö –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏, –∞ –ø–µ—Ä–µ–¥–∞–µ–º —á–µ—Ä–µ–∑ GitHub Secrets –≤ Base64.

**–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å:**
1. –ó–∞–∫–æ–¥–∏—Ä—É–π —Ñ–∞–π–ª –≤ base64 (–ª–æ–∫–∞–ª—å–Ω–æ):
   ```bash
   base64 -i backend/secrets/google-cloud.json | tr -d '\n' | pbcopy
   ```
2. –°–æ–∑–¥–∞–π —Å–µ–∫—Ä–µ—Ç `GOOGLE_CLOUD_CREDENTIALS_B64` –≤ GitHub.
3. –ü—Ä–∏ –¥–µ–ø–ª–æ–µ —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–∫–æ–¥–∏—Ä—É–µ—Ç –µ–≥–æ –≤ `backend/secrets/google-cloud.json`.

## 3. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç CI/CD

–§–∞–π–ª `.github/workflows/deploy.yml` –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –ø—Ä–∏ –ø—É—à–µ –≤ `main`:

1.  **Checkout:** –°–∫–∞—á–∏–≤–∞–µ—Ç –∫–æ–¥.
2.  **Copy:** –ö–æ–ø–∏—Ä—É–µ—Ç —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ SCP/Rsync (–∏—Å–∫–ª—é—á–∞—è `.git`).
3.  **
## üöÄ Top Tier Deployment Setup

We use GitHub Actions for "Push-to-Deploy".
**Key Features:**
1.  **Fast Context**: `.dockerignore` files (root, backend/, frontend/) prevent sending `node_modules` and build artifacts to the server.
2.  **Robust Updates**: logic uses `--force-recreate` to guarantee container updates.
3.  **Log Rotation**: `docker-compose.prod.yml` limits logs to 10MB x 3 files to prevent disk overflow.

### Commands
- **Deploy**: `git push origin main`
- **Manual Restart**: `ssh deploy@HOST "cd kinobot && docker compose -f docker-compose.prod.yml up -d --build --force-recreate"`
–ó–∞—Ö–æ–¥–∏—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ø–æ SSH –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–∫—Ä–∏–ø—Ç:
    -   –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞.
    -   –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ `.env` (–æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤—Ä—É—á–Ω—É—é –æ–¥–∏–Ω —Ä–∞–∑!).
    -   –ó–∞–ø—É—Å–∫–∞–µ—Ç `docker compose -f docker-compose.prod.yml up -d --build`.
    -   –ß–∏—Å—Ç–∏—Ç —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã (`docker image prune`).

## 4. –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ (–†—É—á–Ω–æ–π)

–î–æ –ø–µ—Ä–≤–æ–≥–æ –¥–µ–ø–ª–æ—è –Ω—É–∂–Ω–æ –∑–∞–π—Ç–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∏ —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `.env` —Å –±–æ–µ–≤—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏:

```bash
ssh deploy@your-server
mkdir -p ~/project-name
nano ~/project-name/.env
```
(–°–∫–æ–ø–∏—Ä—É–π —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–∑ `env-template.md` –∏ –∑–∞–ø–æ–ª–Ω–∏ –±–æ–µ–≤—ã–º–∏ –∫–ª—é—á–∞–º–∏).

## 5. Docker Compose (Prod)

–ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º `docker-compose.prod.yml`, –∫–æ—Ç–æ—Ä—ã–π:
-   –°–æ–±–∏—Ä–∞–µ—Ç –æ–±—Ä–∞–∑—ã –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–¥–∞ (`build: context: .`).
-   –í—ã—Å—Ç–∞–≤–ª—è–µ—Ç –ª–µ–π–±–ª—ã –¥–ª—è Traefik (–¥–æ–º–µ–Ω, HTTPS).
-   **–ù–µ –ø—É–±–ª–∏–∫—É–µ—Ç –ø–æ—Ä—Ç—ã –Ω–∞—Ä—É–∂—É** (–∫—Ä–æ–º–µ 80/443 —á–µ—Ä–µ–∑ Traefik). –ë–î –∏ Redis –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ —Å–µ—Ç–∏ Docker.

## 6. –õ–æ–≥–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:
```bash
docker logs project_api --tail 100 -f
docker logs project_bot --tail 100 -f
```
