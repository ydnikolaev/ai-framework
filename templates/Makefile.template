# ü§ñ Project Makefile
# –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω AI-Framework

.PHONY: dev api frontend test lint deploy logs clean help

# === Development ===

dev: ## –ó–∞–ø—É—Å–∫ dev-–æ–∫—Ä—É–∂–µ–Ω–∏—è (Docker Compose)
	docker compose up -d
	@echo "‚úÖ Dev environment started"
	@echo "   Frontend: http://localhost:3000"
	@echo "   API: http://localhost:8080"

api: ## –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ backend
	cd backend && go run ./cmd/api

frontend: ## –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ frontend
	cd frontend && npm run dev -- --host

bot: ## –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ –±–æ—Ç–∞
	cd backend && go run ./cmd/bot

# === Testing ===

test: test-backend test-frontend ## –í—Å–µ —Ç–µ—Å—Ç—ã

test-backend: ## –¢–µ—Å—Ç—ã backend
	cd backend && go test -v ./...

test-frontend: ## –¢–µ—Å—Ç—ã frontend
	cd frontend && npm run test

# === Quality ===

lint: lint-backend lint-frontend ## –í–µ—Å—å –ª–∏–Ω—Ç–∏–Ω–≥

lint-backend: ## –õ–∏–Ω—Ç–∏–Ω–≥ Go
	cd backend && golangci-lint run

lint-frontend: ## –õ–∏–Ω—Ç–∏–Ω–≥ Vue/TS
	cd frontend && npm run lint

typecheck: ## TypeScript –ø—Ä–æ–≤–µ—Ä–∫–∞
	cd frontend && npm run typecheck

# === Database ===

migrate-up: ## –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
	cd backend && go run ./cmd/migrate up

migrate-down: ## –û—Ç–∫–∞—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–≥—Ä–∞—Ü–∏—é
	cd backend && go run ./cmd/migrate down

migrate-create: ## –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é (NAME=xxx)
	cd backend && go run ./cmd/migrate create $(NAME)

# === Docker ===

build: ## –°–æ–±—Ä–∞—Ç—å Docker –æ–±—Ä–∞–∑—ã
	docker compose build

rebuild: ## –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å —Å –Ω—É–ª—è (no cache)
	docker compose build --no-cache

down: ## –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
	docker compose down

logs: ## –õ–æ–≥–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
	docker compose logs -f

logs-api: ## –õ–æ–≥–∏ —Ç–æ–ª—å–∫–æ API
	docker compose logs -f api

logs-bot: ## –õ–æ–≥–∏ —Ç–æ–ª—å–∫–æ –±–æ—Ç–∞
	docker compose logs -f bot

# === Production ===

deploy: ## –î–µ–ø–ª–æ–π –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω (—á–µ—Ä–µ–∑ git push)
	git push origin main
	@echo "üöÄ Deployed! Check GitHub Actions for status."

ssh: ## SSH –Ω–∞ —Å–µ—Ä–≤–µ—Ä
	ssh $(SSH_USER)@$(SSH_HOST)

prod-logs: ## –õ–æ–≥–∏ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
	ssh $(SSH_USER)@$(SSH_HOST) "cd project && docker compose logs -f --tail 100"

prod-restart: ## –†–µ—Å—Ç–∞—Ä—Ç –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
	ssh $(SSH_USER)@$(SSH_HOST) "cd project && docker compose restart"

# === Cleanup ===

clean: ## –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
	rm -rf frontend/.nuxt frontend/.output frontend/node_modules/.vite
	docker system prune -f

# === Help ===

help: ## –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É
	@echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}'

# Default
.DEFAULT_GOAL := help
