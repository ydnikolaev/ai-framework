# ðŸ¤– Project Makefile
# Ð¡Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½ AI-Framework â€” https://github.com/ydnikolaev/ai-framework

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ðŸŽ¨ Colors & Formatting (from DX utilities)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

include .make/dx.mk

# Project-specific commands (optional)
# Create .make/project.mk for your custom commands
# See: ai-framework/core/dx/modular-makefile.md
-include .make/project.mk

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ðŸ“¦ Load Environment
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ifneq (,$(wildcard ./.env))
    include .env
    export
endif

.PHONY: dev api frontend bot test lint deploy logs clean help tunnel bot-stop dev-stop dev-restart
.DEFAULT_GOAL := help

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ðŸ›‘ Process Control
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

bot-stop: ## Stop all local bot processes
	$(call log_header,ðŸ›‘ Stopping Bot Processes)
	@pkill -f "go run ./cmd/bot" 2>/dev/null || true
	@pkill -f "/exe/bot$$" 2>/dev/null || true
	@pkill -f "go-build.*bot$$" 2>/dev/null || true
	$(call log_success,All bot processes stopped!)

dev-stop: ## Stop ALL dev processes (bot, api, frontend, tunnel)
	$(call log_header,ðŸ›‘ Stopping Dev Environment)
	@pkill -f "go run ./cmd/bot" 2>/dev/null || true
	@pkill -f "go run ./cmd/api" 2>/dev/null || true
	@pkill -f "/exe/bot$$" 2>/dev/null || true
	@pkill -f "/exe/api$$" 2>/dev/null || true
	@pkill -f "go-build.*bot$$" 2>/dev/null || true
	@pkill -f "go-build.*api$$" 2>/dev/null || true
	@pkill -f "nuxt dev" 2>/dev/null || true
	@pkill -f "npm run dev" 2>/dev/null || true
	@pkill -f "ssh -R" 2>/dev/null || true
	$(call log_success,Dev environment stopped!)

dev-restart: dev-stop dev ## Restart entire dev environment

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ðŸš€ Development
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

dev: dev-stop ## Start dev environment (Docker Compose)
	$(call log_header,ðŸš€ Starting Dev Environment)
	@docker compose up -d
	$(call log_success,Dev environment started!)
	@printf "$(DIM)   Frontend: http://localhost:3000$(RESET)\n"
	@printf "$(DIM)   API:      http://localhost:8080$(RESET)\n"

api: ## Start backend API
	$(call log_header,âš¡ Starting API Server)
	$(call log_info,API starting on :8080...)
	@cd backend && go run ./cmd/api

frontend: ## Start frontend (Nuxt dev)
	$(call log_header,ðŸŽ¨ Starting Frontend)
	$(call log_info,Nuxt dev server starting...)
	@printf "$(DIM)   Local:   http://localhost:3000$(RESET)\n"
	@printf "$(DIM)   Network: http://0.0.0.0:3000$(RESET)\n\n"
	@cd frontend && npm run dev -- --host

bot: ## Start Telegram bot
	$(call log_header,ðŸ¤– Starting Telegram Bot)
	$(call log_info,Bot is starting...)
	@cd backend && go run ./cmd/bot

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ðŸ§ª Testing
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

test: test-backend test-frontend ## Run all tests
	$(call log_success,All tests passed!)

test-backend: ## Run backend tests
	$(call log_header,ðŸ§ª Backend Tests)
	@cd backend && go test -v ./...

test-frontend: ## Run frontend tests
	$(call log_header,ðŸ§ª Frontend Tests)
	@cd frontend && npm run test 2>/dev/null || echo "No frontend tests configured"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ðŸ” Quality
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

lint: lint-backend lint-frontend ## Run all linters
	$(call log_success,Linting complete!)

lint-backend: ## Lint Go code
	$(call log_header,ðŸ” Go Linting)
	@cd backend && golangci-lint run 2>/dev/null || echo "golangci-lint not installed"

lint-frontend: ## Lint Vue/TS code
	$(call log_header,ðŸ” Frontend Linting)
	@cd frontend && npm run lint 2>/dev/null || echo "No lint script"

typecheck: ## TypeScript type check
	$(call log_header,ðŸ“ TypeScript Check)
	@cd frontend && npm run typecheck 2>/dev/null || npx nuxi typecheck

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ðŸ—„ï¸ Database
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

db: ## Start database containers
	$(call log_header,ðŸ³ Starting Database)
	@docker compose up -d
	$(call log_success,Database is running!)
	@printf "$(DIM)   PostgreSQL: localhost:5432$(RESET)\n"
	@printf "$(DIM)   Redis:      localhost:6379$(RESET)\n"

db-reset: ## âš ï¸ WIPE all data and restart DBs
	@python3 ./scripts/dx-confirm.py "Ð¡Ð‘Ð ÐžÐ¡ Ð‘ÐÐ—Ð« Ð”ÐÐÐÐ«Ð¥" "Ð’ÑÐµ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð±ÑƒÐ´ÑƒÑ‚ Ð£Ð”ÐÐ›Ð•ÐÐ«!\nÐ­Ñ‚Ð¾ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ€Ð°Ñ‚Ð¸Ð¼Ð¾."
	$(call log_header,ðŸ—‘ï¸  Resetting Database)
	$(call log_warning,This will DELETE all data!)
	@docker compose down -v
	@docker compose up -d
	$(call log_info,Waiting for Database to initialize...)
	@sleep 5
	$(call log_success,Database reset complete!)

migrate-up: ## Apply migrations
	$(call log_header,ðŸ”„ Running Migrations)
	@cd backend && go run ./cmd/migrate up
	$(call log_success,Migrations applied!)

migrate-down: ## Rollback last migration
	$(call log_header,ðŸ”„ Rolling Back Migration)
	$(call log_warning,Rolling back last migration...)
	@cd backend && go run ./cmd/migrate down

migrate-create: ## Create new migration (NAME=xxx)
	$(call log_header,ðŸ“ Creating Migration)
	@cd backend && go run ./cmd/migrate create $(NAME)
	$(call log_success,Migration created!)

db-sync-from-prod: ## âš ï¸ Download PROD database and replace DEV
	@python3 ./scripts/dx-confirm-sync.py "$(PROD_SERVER)" "$(PROD_DIR)"
	@printf "\n"
	$(call log_header,ðŸ”„ Syncing PROD â†’ DEV)
	$(call log_info,Step 1/3: Dumping PROD database...)
	@ssh $(PROD_SERVER) "docker exec $${PROJECT_NAME}_db pg_dump -U user -d $${PROJECT_NAME} --clean --if-exists" > /tmp/prod_dump.sql
	@printf "$(GREEN)$(BOLD)âœ“$(RESET) PROD dump complete! ($$(wc -c < /tmp/prod_dump.sql | xargs) bytes)\n"
	$(call log_info,Step 2/3: Dropping DEV database...)
	@docker exec $${PROJECT_NAME}_db psql -U user -d postgres -c "DROP DATABASE IF EXISTS $${PROJECT_NAME}_dev;" 2>/dev/null || true
	@docker exec $${PROJECT_NAME}_db psql -U user -d postgres -c "CREATE DATABASE $${PROJECT_NAME}_dev;" 2>/dev/null || true
	$(call log_info,Step 3/3: Restoring to DEV...)
	@docker exec -i $${PROJECT_NAME}_db psql -U user -d $${PROJECT_NAME}_dev < /tmp/prod_dump.sql
	@rm /tmp/prod_dump.sql
	$(call log_success,DEV database synced from PROD!)
	@printf "\n$(GREEN)$(BOLD)âœ¨ Done!$(RESET) $(DIM)DEV Ñ‚ÐµÐ¿ÐµÑ€ÑŒ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ ÐºÐ¾Ð¿Ð¸ÑŽ PROD Ð´Ð°Ð½Ð½Ñ‹Ñ….$(RESET)\n\n"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ðŸ³ Docker
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

build: ## Build Docker images
	$(call log_header,ðŸ³ Building Docker Images)
	@docker compose build
	$(call log_success,Build complete!)

rebuild: ## Rebuild from scratch (no cache)
	$(call log_header,ðŸ³ Rebuilding Docker Images)
	$(call log_warning,Building without cache...)
	@docker compose build --no-cache
	$(call log_success,Rebuild complete!)

down: ## Stop all containers
	$(call log_header,ðŸ›‘ Stopping Containers)
	@docker compose down
	$(call log_success,All containers stopped!)

logs: ## Show Docker logs
	$(call log_header,ðŸ“‹ Docker Logs)
	@docker compose logs -f --tail 50

logs-api: ## Show API logs only
	@docker compose logs -f api

logs-bot: ## Show bot logs only
	@docker compose logs -f bot

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ðŸŒ Dev Tunnel
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

tunnel: ## Open SSH tunnel for remote testing
	$(call log_header,ðŸŒ Dev Tunnel)
	$(call log_info,Opening SSH tunnel...)
	@printf "$(CYAN)   Local:$(RESET)  localhost:3000\n"
	@printf "$(CYAN)   Remote:$(RESET) https://$(TUNNEL_HOST)\n\n"
	$(call log_warning,Press Ctrl+C to close tunnel)
	@printf "$(DIM)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€$(RESET)\n"
	@ssh -R $(TUNNEL_PORT):localhost:3000 $(SSH_USER)@$(SSH_HOST) -N

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ðŸ”— Telegram Webhook
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

set-webhook-dev: ## Set dev bot webhook
	$(call log_header,ðŸ”— Setting Dev Webhook)
	@./scripts/set-webhook.sh dev

set-webhook-prod: ## Set production bot webhook
	$(call log_header,ðŸ”— Setting Prod Webhook)
	@./scripts/set-webhook.sh prod

add-dev-routes: ## Add dev tunnel routes to Traefik on server
	$(call log_header,ðŸ”§ Adding Dev Routes to Traefik)
	@./scripts/add-dev-routes.sh

setup-ssh: ## Setup SSH keys and config for this project
	$(call log_header,ðŸ” Setting up SSH)
	@./scripts/setup-ssh.sh

setup-repo: ## Create GitHub repo and push initial commit
	$(call log_header,ðŸ”— Setting up GitHub repository)
	@./scripts/setup-repo.sh

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ðŸš€ Production
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

deploy: ## Deploy to production (git push)
	$(call log_header,ðŸš€ Deploying to Production)
	$(call log_warning,Pushing to main branch...)
	@git push origin main
	$(call log_success,Deployed! Check GitHub Actions for status.)

ssh: ## SSH to production server
	$(call log_header,ðŸ” SSH to Production)
	@ssh $(SSH_USER)@$(SSH_HOST)

prod-logs: ## Show production logs
	$(call log_header,ðŸ“‹ Production Logs)
	@ssh $(SSH_USER)@$(SSH_HOST) "cd $(PROJECT_DIR) && docker compose logs -f --tail 100"

prod-restart: ## Restart production containers
	$(call log_header,ðŸ”„ Restarting Production)
	$(call log_warning,Restarting containers on production...)
	@ssh $(SSH_USER)@$(SSH_HOST) "cd $(PROJECT_DIR) && docker compose restart"
	$(call log_success,Production restarted!)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ðŸ§¹ Cleanup
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

clean: ## Clean temporary files
	$(call log_header,ðŸ§¹ Cleaning Up)
	$(call log_info,Removing build artifacts...)
	@rm -rf frontend/.nuxt frontend/.output frontend/node_modules/.vite
	$(call log_info,Pruning Docker...)
	@docker system prune -f
	$(call log_success,Cleanup complete!)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ðŸ“š Help
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

help: ## Show this help
	@printf "\n$(BOLD)$(MAGENTA)ðŸ¤– Project Name$(RESET) $(DIM)â€” Available Commands$(RESET)\n\n"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@printf "\n$(DIM)Usage: make <command>$(RESET)\n\n"
